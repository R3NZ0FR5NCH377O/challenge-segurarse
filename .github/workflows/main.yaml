name: Pipeline CI/CD Docker

on:
  push:
    branches:
      - main

jobs:
  construir-y-desplegar:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
      - name: Notificar clonaci√≥n
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚úÖ Clonaci√≥n del repositorio completada en ${{ github.repository }} por ${{ github.actor }}."

      - name: Iniciar sesi√≥n en DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Notificar inicio de sesi√≥n en DockerHub
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "üîë Inicio de sesi√≥n en DockerHub completado."
      - name: Notificar fallo en inicio de sesi√≥n
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚ùå Fallo al iniciar sesi√≥n en DockerHub."

      - name: Construir imagen Docker
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/challenge-segurarse:${{ github.sha }} .
      - name: Notificar construcci√≥n de imagen
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "üèóÔ∏è Imagen Docker construida: ${{ secrets.DOCKERHUB_USERNAME }}/challenge-segurarse:${{ github.sha }}."
      - name: Notificar fallo en construcci√≥n
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚ùå Fallo al construir la imagen Docker."

      - name: Subir imagen Docker
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/challenge-segurarse:${{ github.sha }}
      - name: Notificar subida de imagen
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "üöÄ Imagen Docker subida a DockerHub: ${{ secrets.DOCKERHUB_USERNAME }}/challenge-segurarse:${{ github.sha }}."
      - name: Notificar fallo en subida
        if: failure stray()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚ùå Fallo al subir la imagen a DockerHub."

      - name: Autenticar en Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Notificar autenticaci√≥n en GCP
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "üîê Autenticaci√≥n con Google Cloud completada."
      - name: Notificar fallo en autenticaci√≥n
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚ùå Fallo al autenticar con Google Cloud."

      - name: Configurar gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      - name: Notificar configuraci√≥n de gcloud
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "üõ†Ô∏è Configuraci√≥n de gcloud CLI completada para el proyecto ${{ secrets.GCP_PROJECT_ID }}."
      - name: Notificar fallo en configuraci√≥n
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚ùå Fallo al configurar gcloud CLI."

      - name: Analizar c√≥digo con Bandit
        run: |
          pip install bandit
          bandit -r . -f txt -o bandit-report.txt || true
      - name: Notificar an√°lisis de Bandit
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "üîç An√°lisis est√°tico con Bandit completado. Enviando reporte..."
          document: bandit-report.txt

      - name: Desplegar en Google Cloud Run
        id: deploy
        run: |
          gcloud run deploy challenge-segurarse \
            --image=${{ secrets.DOCKERHUB_USERNAME }}/challenge-segurarse:${{ github.sha }} \
            --platform=managed \
            --region=us-central1 \
            --allow-unauthenticated
          echo "DEPLOY_URL=$(gcloud run services describe challenge-segurarse --region=us-central1 --format='value(status.url)')" >> $GITHUB_OUTPUT
      - name: Notificar despliegue
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "üåê Despliegue a Google Cloud Run completado: challenge-segurarse en us-central1. URL: ${{ steps.deploy.outputs.DEPLOY_URL }}"
      - name: Notificar fallo en despliegue
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚ùå Fallo al desplegar en Google Cloud Run."
